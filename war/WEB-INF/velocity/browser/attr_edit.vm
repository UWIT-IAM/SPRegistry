#* ========================================================================
 * Copyright (c) 2012 The University of Washington
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================================
 *#

## This edits only one editable policy
## For more policies, use more of these

#parse ( 'definitions.vm' )


#foreach ( $grp in $filterPolicyGroups )
 #if ( $grp.editable )
   #set ($group=$grp)
   #set ($gid=$group.id)
 #end
#end

<div id="attrEditDialog" dojoType="iam/Dialog" title="Edit attributes for ${relyingPartyId}" 
    data-dojo-props="submitLabel:'Save changes', submitAction:'attr_saveAttrs(\'${gid}\', \'${relyingPartyId}\')', cancelLabel:'Cancel'"
    $hide >

<table class="iamtable">

    <tr><th colspan="9">Description of attributes</th></tr>
     <tr><td class="label" colspan="9">See the IAM wiki's <a href="https://wiki.cac.washington.edu/x/QUioAQ">Guide to Attributes</a>.</td></tr>
     <tr><td colspan="9">Please allow 40 minutes for our IdP to acquire
        the changes to this service provider's attribute release policy.
       </td></tr>

    <tr><th colspan="9">Attributes from by $group.description</th></tr>
     <tr><td colspan="3">
       <table class="iamtable" >
    
     #set ( $policy = false )
     #set ( $policy = $group.getFilterPolicy($relyingPartyId) )
     #foreach ( $attr in $attributes )
       #set ($chk = '')
       #set ($pattr = false )
       ## see if policy exists for this sp and attr
       #if ($policy)
         #foreach ( $p in $policy.attributeRules )
          #if ($attr.id==$p.id) 
            #set ($chk = 'checked="checked"')
            #set ($pattr = $p )
          #end
         #end
       #end

       <tr><td class="label" width="40"><span data-dojo-type="dijit.form.CheckBox" $chk  value="${attr.id}" id="${gid}_attr_edit_chk_${attr.id}"
              class="${gid}_attr_edit_chk" onClick="attr_checkAttr('$gid', '$!{attr.id}')"></span></td>
           <td align="left">$!{attr.id}
            <input id="${gid}_attr_edit_chk_${attr.id}_in" value="$chk" type="hidden"></input>
            </td>
       </tr>
       
       ## show any existing releases
       #set ($count=0)
       #set ($started = false)
       #foreach ( $value in $pattr.valueRules )
          #set( $started = true )
          <tr id="${gid}_attr_edit_tr_all_${attr.id}">
              <td></td><td><span data-dojo-type="dijit.form.CheckBox" id="${gid}_attr_edit_all_$!{attr.id}" onClick="attr_checkAll('$gid', '$!{attr.id}')"
            #if ( $value.type == "basic:ANY" ) $checked #end></span>all values</td></tr>
            #foreach ( $rule in $value.rules )
              <tr id="${gid}_attr_edit_tr_v_${count}_$!{attr.id}"><td></td><td nowrap="nowrap">
                  <span data-dojo-type="dijit.form.TextBox" 
                          id="${gid}_attr_edit_v_${count}_$!{attr.id}" value="${rule.value}" style="width:400px"></span>
                     <span data-dojo-type="dijit.form.CheckBox" id="${gid}_attr_edit_x_${count}_$!{attr.id}"
                       #if ($rule.regex) $checked #end></span>regex</td></tr>
              #set ($count = $count + 1)
            #end ## value counts
       #end
       #if (!$started)
          <tr id="${gid}_attr_edit_tr_all_${attr.id}" $hide>
             <td></td><td><span data-dojo-type="dijit.form.CheckBox" id="${gid}_attr_edit_all_$!{attr.id}"
                  onClick="attr_checkAll('$gid', '$!{attr.id}')"></span>all values</td></tr>
       #end
       #foreach ( $i in [ $count .. 10 ] )
         <tr $hide id="${gid}_attr_edit_tr_v_${i}_$!{attr.id}"><td></td><td nowrap="nowrap">
             <span data-dojo-type="dijit.form.TextBox" id="${gid}_attr_edit_v_${i}_$!{attr.id}" value="" style="width:400px"
                  onClick="attr_showNext('$gid', ${i},'$!{attr.id}')"></span>
                 <span data-dojo-type="dijit.form.CheckBox" id="${gid}_attr_edit_x_${i}_$!{attr.id}"></span>regex</td></tr>
       #end  ## xtra counts
     #end ## attr


   </table></td></tr>

  </table>


## error and status messages
## <div id="requestStatusDiv" class="notice" $hide>&nbsp;
## </div>
## <div class="status">$!{status}
## </div>

</div>
