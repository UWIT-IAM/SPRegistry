#* ========================================================================
 * Copyright (c) 2009-2011 The University of Washington
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================================
 *#

##
## Templates for rp edit 
##

<script>
v_sectionType = 'rp';

var entityId;

// pseudo getbyname that works with ie
function getElementsByIdname(base) {
   var list = [];
   var i = 0;
   while (document.getElementById(base + '_' + i)) {
      list.push(document.getElementById(base + '_' + i++));
   }
   return list;
}

// show some inputs
function showMoreFields(name, id) {
   // show the first set of hidden ones
   for (e=0; e<20; e++) {
     var enam = name + e;
     list = getElementsByIdname(name+e);
     if (list.length==0) break;
     if (list[0].style.display == '') continue;
     for (i=0; i<list.length; i++) {
        list[i].style.display = '';
        list[i].className = 'messyDetail';
     }
     return;
   }
   plus = document.getElementById(id);
   plus.style.display = 'none';
}

// submit the changes
function saveRP() {
   xml = '';
   xml = assembleRPMetadata();
   if (xml!='') {
     finalAction = '${root}${vers}/rp?id=' + entityId;
     // alert (xml);
     doRequest('PUT', '${root}${vers}/rp?id=' + entityId + '&mdid=UW&xsrf=${xsrf}', xml, null);
     // doRequest('POST', '/env.cgi?id=' + entityId + '&mdid=UW', xml, null);
   }
}

// build the rp xml
function assembleRPMetadata() {
   entityId = document.getElementById('entityid').value.trim();
   if (entityId=='') {
      alert("You must provide an EntityID");
      return '';
   }
   var xml = '<EntityDescriptor entityID="' + entityId + '">';

   // SPSSO
   pse = '';
   for (i=0; i<5; i++) {
      e = document.getElementById('pse_' + i);
      if (e!=null) {
         v = e.value.trim();
         if (v == '') continue;
         if (pse=='') pse = 'protocolSupportEnumeration="' + e.value.trim();
         else pse = pse + ' ' + e.value.trim();
      }
   }
   if (pse=='') {
      alert("You must provide at least one protocol ");
      return '';
   }
   xml = xml + '<SPSSODescriptor ' + pse + '">';

   // keyinfo
   hadKi = false;
   for (i=0; i<4; i++) {
      kn = document.getElementById('kn_' + i);
      kc = document.getElementById('kc_' + i);
      knv = kn.value.trim();
      kcv = kc.value.trim();
      if (knv=='' && kcv=='') continue;
      ki = '<KeyDescriptor><ds:KeyInfo>';
      if (knv!='') ki = ki + '<ds:KeyName>' + knv + '</ds:KeyName>';
      if (kcv!='') ki = ki + '<ds:X509Data><ds:X509Certificate>' + kcv + '</ds:X509Certificate></ds:X509Data>';
      ki = ki + '</ds:KeyInfo></KeyDescriptor>';
      xml = xml + ki;
      hadKi = true;
   }
   if (!hadKi) {
      alert("You must provide KeyInfo");
      return '';
   }

   // nameid
   for (i=0; i<5; i++) {
      e = document.getElementById('ni_' + i);
      if (e!=null) {
         v = e.value.trim();
         if (v == '') continue;
         xml = xml + '<NameIDFormat>' + v + '</NameIDFormat>';
      }
   }
   
   // acs
   hadAcs = false;
   for (i=0; i<50; i++) {
      idx = document.getElementById('acsi_' + i);
      idxv = idx.value.trim();
      if (idxv=='') continue;
      bv = document.getElementById('acsb_' + i).value.trim();
      lv = document.getElementById('acsl_' + i).value.trim();
      xml = xml + '<AssertionConsumerService index="' + idxv + '" ';
      xml = xml + 'Binding="' + bv + '" Location="' + lv + '"/>';
      hadAcs = true;
   }
   if (!hadAcs) {
      alert("You must provide an ACS");
      return '';
   }
   xml = xml + '</SPSSODescriptor>';

   // org (only one really)
   for (i=0; i<1; i++) {
      xml = xml + '<Organization>';
      v = document.getElementById('orgn_' + i).value.trim();
      if (v!='') xml = xml + '<OrganizationName>' + v + '</OrganizationName>';
      else {
         alert("You must provide an Org name");
         return '';
      }
      v = document.getElementById('orgd_' + i).value.trim();
      if (v!='') xml = xml + '<OrganizationDisplayName>' + v + '</OrganizationDisplayName>';
      else {
         alert("You must provide an Org display name");
         return '';
      }
      v = document.getElementById('orgu_' + i).value.trim();
      if (v!='') xml = xml + '<OrganizationURL>' + v + '</OrganizationURL>';
      else {
         alert("You must provide an Org URL");
         return '';
      }
      xml = xml + '</Organization>';
   }
   
   // contact
   hadName = false;
   hadMail = false;
   hadPhone = false;
   for (i=0; i<5; i++) {
      v = document.getElementById('ctt_' + i).value.trim();
      if (v=='') continue;
      xml = xml + '<ContactPerson contactType="' + v + '">';
      v = document.getElementById('ctgn_' + i).value.trim();
      if (v!='') {
         xml = xml + '<GivenName>' + v + '</GivenName>';
         hadName = true;
      }
#**
      v = document.getElementById('ctsn_' + i).value.trim();
      if (v!='') xml = xml + '<SurName>' + v + '</SurName>';
**#
      v = document.getElementById('cte_' + i).value.trim();
      if (v!='') {
         xml = xml + '<EmailAddress>' + v + '</EmailAddress>';
         hadMail = true;
      }
      v = document.getElementById('ctp_' + i).value.trim();
      if (v!='') {
         xml = xml + '<TelephoneNumber>' + v + '</TelephoneNumber>';
         hadPhone = true;
      }
      xml = xml + '</ContactPerson>';
   }
   if (!hadName) {
      alert("You must provide a contact name");
      return '';
   }
   if (!hadMail) {
      alert("You must provide a contact Email address");
      return '';
   }
 
   xml = xml + '</EntityDescriptor>';

   return xml;
}

// delete an rp
function deleteRP() {
   entityId = document.getElementById('entityid').value.trim();
   if (entityId=='') return;
   if (!confirm('Permanently delete the Service Provider: ' + entityId + '?')) return;

   finalAction = showDeletedGroup;
   doRequest('DELETE', '${root}${vers}/rp?id=' + entityId + '&mdid=UW&xsrf=${xsrf}', '', null);
}

function showDeletedGroup()
{
   page=document.getElementById('PageContent');
   page.innerHTML = '<p>Service provider ${relyingParty.entityId} deleted.</p>';
}


</script>

## crumbs

#parse ( "crumbs.vm" )

##
## ----- Left side content -----
##

#pageStart

<form id="rpForm" action="" method="POST">

<table cellpadding="0" cellspacing="0" border="0">


#if ( $metadataByLookup )
  <tr><td>This metadata was generated by the Service Provider's Metadata response.</td></tr>
#end
#if ( $metadataByDefault )
  <tr><td class="warn">Your Service Provider did not respond to a request for metadata. 
These are default values for a Shibboleth 2.x Service Provider.  They will very likely need to be edited.</td></tr>
#end

<tr>
 <td class="optionbar" align="left" colspan="99">
    <b>Metadata</b>
    &nbsp;|&nbsp;<a href="javascript:goTo('${root}${vers}/rp/attr?id=${relyingParty.entityId}&mdid=${relyingParty.metadataId}')" title="Show attributes release to the rp">Attributes</a>
</tr>

<tr>
 <td class="optionbot" align="left" colspan="99">
    #if ( ! $newEntity )
     <a href="javascript:goTo('${root}${vers}/rp?id=${relyingParty.entityId}&mdid=${relyingParty.metadataId}')">View</a>
     &nbsp;&nbsp;Edit
     &nbsp;&nbsp;<a href="javascript:deleteRP()">Delete</a>
    #else
     New
    #end
 </td>
</tr>


 <tr><td height="10px" colspan="99"/></tr>

    ## class codes borrowed from gws
    <tr><td class="groupindenttitle" >General information</td></tr>
     <tr><td class="groupindent">
       <table >

## entity id

      <tr><td class="grouplabel">Entity Id</td>
      <td>
    #if ( ! $newEntity )
       <input type="hidden" id="entityid" value="${relyingParty.entityId}"/>${relyingParty.entityId}
    #else
       <input type="text" size="50" id="entityid" value="$!{relyingParty.entityId}"/>
    #end
      <td/></tr>

 
## Organization
   #set ( $count = 0 )

      #set ( $org = $relyingParty.organization )
      <tr><td class="grouplabel">Organization</td>
      </tr>

   #if ( $org )
     <tr id="org0_0">
      <td class="groupitem" align="left" >Name:</td><td><input type="text" size="50" id="orgn_0" value="$!org.name" /></td>
     </tr>
     <tr id="org0_1">
      <td class="groupitem" align="left" >Display:</td><td><input type="text" size="50" id="orgd_0" value="$!org.displayName" /></td>
     </tr>
     <tr id="org0_2">
      <td class="groupitem" align="left" >Url:</td><td><input type="text" size="50" id="orgu_0" value="$!org.url" /></td>
     </tr>
     #set ( $count = $count + 1)
   #end

   ## Org only once?
   #if ( $count == 0 )
     <tr id="org0_0">
      <td class="groupitem" align="left" >Name:</td><td><input type="text" size="50" id="orgn_0" value="" /></td>
     </tr>
     <tr id="org0_1">
      <td class="groupitem" align="left" >Display:</td><td><input type="text" size="50" id="orgd_0" value="" /></td>
     </tr>
     <tr id="org0_2">
      <td class="groupitem" align="left" >Url:</td><td><input type="text" size="50" id="orgu_0" value="" /></td>
     </tr>
   #end

 
 ## Contacts
      <tr><td class="grouplabel">Contact persons</td>
      </tr>
   #set ( $count = 0 )
   #foreach ( $ct in $relyingParty.contactPersons )
     <tr id="ct${count}_0">
      <td class="groupitem" align="left" >Type:</td><td>
       <select id="ctt_${count}">
       #foreach ( $t in ["","technical","support","administrative","billing","other"] )
         <option value="$t" 
           #if ( $t == $ct.type )
             selected="selected"
           #end
         >$t</option>
       #end
       </select>
     </td>
     </tr>
     <tr id="ct${count}_1">
      <td class="groupitem" align="left" >Name:</td><td><input type="text" size="50" id="ctgn_${count}" value="$!ct.givenName" /></td>
     </tr>
     <tr id="ct${count}_2">
      <td class="groupitem" align="left" >Email:</td><td><input type="text" size="50" id="cte_${count}" value="$!ct.email" /></td>
     </tr>
     <tr id="ct${count}_3">
      <td class="groupitem" align="left" >Phone:</td><td><input type="text" size="50" id="ctp_${count}" value="$!ct.phone" /></td>
     </tr>
     <tr><td/><td colspan="99" height="5"></td></tr>
     #set ( $count = $count + 1)
   #end
 
   #foreach ( $i in [ $count .. 4 ] )
     <tr id="ct${i}_0" #if ( $i > 1 ) ${hide} #end >
      <td class="groupitem" align="left" >Type:</td><td>
       <select id="ctt_${i}">
       #foreach ( $t in ["","technical","support","administrative","billing","other"] )
         <option value="$t" 
           #if ( $t == "" )
             selected="selected"
           #end
         >$t</option>
       #end
       </select>
     </td>
     </tr>
     <tr id="ct${i}_1" #if ( $i > 1 ) ${hide} #end >
      <td class="groupitem" align="left" >Name:</td><td><input type="text" size="50" id="ctgn_${i}" value="" /></td>
     </tr>
     <tr id="ct${i}_2" #if ( $i > 1 ) ${hide} #end >
      <td class="groupitem" align="left" >Email:</td><td><input type="text" size="50" id="cte_${i}" value="" /></td>
     </tr>
     <tr id="ct${i}_3" #if ( $i > 1 ) ${hide} #end >
      <td class="groupitem" align="left" >Phone:</td><td><input type="text" size="50" id="ctp_${i}" value="" /></td>
     </tr>
     #set ( $label = "" )
     <tr><td/><td colspan="99" height="3"></td></tr>
   #end
     <tr id="ct_more"><td/><td class="cleanlink"><a href="javascript:showMoreFields('ct', 'ct_more')">+</a></td></tr>

  </table></td></tr>


## Details

     <tr><td class="groupindenttitle" >Metadata details</td>
     </tr>
#if ( ! $newEntity )
<tr>
 <td class="optionbot" align="left" colspan="99">
     <span id="showDetail"><a href="javascript:toggleDetail()">Show</a></span>
     <span id="hideDetail" ${hide} ><a href="javascript:toggleDetail()">Hide</a></span>
 </td>
</tr>
#end

     <tr><td class="groupindent" id="messyDetail" #if (!$newEntity ) ${hide} #end >
       <table >


 ## ProtocolSupportEnumerations

      <tr><td class="grouplabel">Protocols</td>
      </tr>
   #set ( $count = 0 )
   #foreach ( $ps in $relyingParty.protocolSupportEnumerations )
     <tr id="pse${count}_0">
      <td class="groupitem"</td><td><input type="text" size="40" name="pse_data" id="pse_${count}" value="$ps" /></td>
     </tr>
     #set ( $count = $count + 1)
   #end

   #foreach ( $i in [ $count .. 4 ] )
     <tr id="pse${i}_0" ${hide}>
      <td class="groupitem"></td><td><input type="text" size="40" name="pse" id="pse_${i}" value="" /></td>
     </tr>
   #end
   <tr id="pse_more"><td/><td class="cleanlink"><a href="javascript:showMoreFields('pse', 'pse_more')">+</a></td></tr>
 
   ## KeyInfo

      <tr><td class="grouplabel">KeyInfo</td>
      </tr>
   #set ( $count = 0 )
   #foreach ( $key in $relyingParty.keyDescriptors )
      <tr id="ki${count}_0">
      <td class="groupitem" align="left">Name:</td>
        <td><input type="text" size="40" name="keyName_${count}" id="kn_${count}" value="$!key.keyName" /></td>
      </tr>

      <tr id="ki${count}_1">
      <td class="groupitem" align="left" valign="top">Cert:</td>
         <td class="certbox"><textarea cols="64" rows="5" name="keyCert_${count}" id="kc_${count}">$!key.certificate</textarea></td>
      </tr>
     #set ( $count = $count + 1)
   #end

   #foreach ( $i in [ $count .. 3 ] )
   
      <tr id="ki${i}_0" ${hide}>
      <td class="groupitem" align="left">Name:</td>
        <td><input type="text" size="40" name="keyName_${i}" id="kn_${i}" value="" /></td>
      </tr>
      <tr id="ki${i}_1" ${hide}>
      <td class="groupitem" align="left" valign="top">Cert:</td>
         <td class="certbox"><textarea cols="64" rows="10" name="keyCert_${i}" id="kc_${i}"></textarea></td>
      </tr>

   #end
     <tr id="ki_more"><td/><td class="cleanlink"><a href="javascript:showMoreFields('ki', 'ki_more')">+</a></td></tr>

 
   ## Nameid

      <tr><td class="grouplabel">NameID</td>
      </tr>
   #set ( $count = 0 )
   #foreach ( $name in $relyingParty.nameIDFormats )
     <tr id="ni${count}_0">
      <td class="groupitem"><td><input type="text" size="40" name="nameId_${count}" id="ni_${count}" value="$name" /></td>
     </tr>
     #set ( $count = $count + 1)
   #end

   #foreach ( $i in [ $count .. 4 ] )
     <tr id="ni${i}_0" ${hide}>
      <td class="groupitem"><td><input type="text" size="40" name="nameId_${xtra}" id="ni_${i}" value="" /></td>
     </tr>
   #end
     <tr id="ni_more"><td/><td class="cleanlink"><a href="javascript:showMoreFields('ni', 'ni_more')">+</a></td></tr>
 
   ## ACS
      <tr><td class="grouplabel" colspan="99">ACS</td>
      </tr>
   #set ( $count = 0 )
   #foreach ( $acs in $relyingParty.assertionConsumerServices )
     <tr id="acs${count}_0">
      <td class="groupitem" align="right" ><input type="text" size="2" id="acsi_${count}" value="$acs.index"/></td>
             <td nowrap="nowrap"><input type="text" size="50" id="acsb_${count}" value="$acs.binding" /></td>
     </tr>
     <tr id="acs${count}_1">
      <td class="groupitem" align="left" ></td>
             <td nowrap="nowrap"><input type="text" size="50" id="acsl_${count}" value="$acs.location" /></td>
     </tr>
     <tr><td></td><td colspan="99" height="3"></td></tr>
     #set ( $count = $count + 1)
   #end

   #foreach ( $i in [ $count .. 49 ] )
     <tr id="acs${i}_0" ${hide}>
      <td class="groupitem" align="right" ><input type="text" size="2" id="acsi_${i}" value=""/></td>
             <td nowrap="nowrap"><input type="text" size="50" id="acsb_${i}" value="" /></td>
     </tr>
     <tr id="acs${i}_1" ${hide}><td></td>
             <td nowrap="nowrap"><input type="text" size="50" id="acsl_${i}" value="" /></td>
     </tr>
   #end
     <tr id="acs_more"><td/><td class="cleanlink"><a href="javascript:showMoreFields('acs', 'acs_more')">+</a></td></tr>

</table></td></tr>


   <tr><td/><td colspan="99"><hr></td></tr>

  </table>
 </form>


## submitter

#if ( $newEntity )
<span>Your submission will be processed automatically.  Please allow a couple of hours for our IdP to acquire
your new service provider's metadata. 
</span>
#else
<span>Your submission will be processed automatically.  Please allow a couple of hours for our IdP to acquire
your service provider's changed metadata. 
</span>
#end

<form id="submitter" action="#rp">
<input id="submitterButton" type="button" name="save" #if ( $newEntity ) value="Create" #else value="Save changes" #end onClick="saveRP()">
</form>


#pageMiddle

##
## ----- right side extra text ----
##


<p height="100px">&nbsp;</p>


<table class="helptext" cellpadding="4px">
<tr><th align="left" colspan="2">Service Provider Metadata</td></tr>
#if ( ! $newEntity )
<tr class="messyDetail" ${hide}><td width="10px"/><td valign="top">Shown are the details of the
  Service Provider's metadata.
   </td></tr>
<tr class="cleanDetail"><td width="10px"/><td valign="top">Shown is a summary of the
  Service Provider's metadata.  Click <i>Show</i> to see the details
   of these metadata.
   </td></tr>
<tr><td width="10px"/><td valign="top">Clear an entry to delete it.
   </td></tr>
#else
<tr><td width="10px"/><td valign="top">Your entity id must begin with
<br/><b>https://<i>your_dns_name</i>/</b>
   </td></tr>
<tr><td width="10px"/><td valign="top">If you enter a previously registered entity id, the new
information will replace the existing information.
   </td></tr>

<tr><td width="10px"/><td valign="top">Click on the <b>+</b> to add additional entries.
   </td></tr>
#end
</table>


##
## ----- end -----
##

#pageEnd

## error and status messages
<div id="requestStatusDiv" class="notice">&nbsp;
</div>
<div class="status">$!{status}
</div>

